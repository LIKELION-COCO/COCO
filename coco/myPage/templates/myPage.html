{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="stylesheet" href="{% static 'css/myPage.css'%}" />
    <title>Document</title>
  </head>
  <script>
    const goToDetail = (id) => {
      const url = `/myPage/detailArticle/${id}/`;
      window.location.href = url;
    };
    const goToNewArticle = () => {
      window.location.href = "/myPage/newArticle";
    };
    let isEditing = false;
    const editBackground = (id) => {
        if (!isEditing){
            var profileDivs = document.getElementsByClassName("profileContainer");
            for (var i = 0; i < profileDivs.length; i++) {
              profileDivs[i].style.display = "none";
            }
            var btns = document.getElementsByClassName("addBgButton");
            for (var i = 0; i < btns.length; i++) {
              btns[i].style.display = "block";
            }
            var addImageBtn = document.getElementsByClassName("addImageBtn");
            for (var i = 0; i < addImageBtn.length; i++) {
              addImageBtn[i].style.transform = 'rotate(45deg)';
            }
            var articlePart = document.querySelectorAll('#articlePart');
            articlePart.forEach(element => {
                element.style.display = 'none';
            }); 
        }else{
            window.location.href = `/myPage/${id}/`
        }
        isEditing = !isEditing;
    };
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        var cookies = document.cookie.split(";");
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          // 토큰의 이름으로 시작하는 쿠키를 찾습니다.
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function chooseFile(id) {
      var fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.style.display = "none";

      fileInput.addEventListener("change", function () {
        var file = fileInput.files[0];
        var imageElement = document.getElementById(id);
        var reader = new FileReader();

        reader.onload = function (e) {
          imageElement.src = e.target.result;
        };

        reader.readAsDataURL(file);

        // 파일 선택 후에 input 요소를 삭제
        fileInput.remove();

        // CSRF 토큰 가져오기
        var csrftoken = getCookie("csrftoken");

        var formData = new FormData();
        formData.append("file", file);
        formData.append("title", id);

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/myPage/upload/", true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              console.log("파일 업로드 성공");
            } else {
              console.log("파일 업로드 실패");
            }
          }
        };

        // 헤더에 CSRF 토큰 추가
        xhr.setRequestHeader("X-CSRFToken", csrftoken);

        xhr.send(formData);
      });

      document.body.appendChild(fileInput);
      fileInput.click();
    }
  </script>
  <body>
    <header id="header">
      <div class="header_div">
        <div class="logo inline">
          <a href="{% url 'town:mainPage'%}">
            <img src="{% static 'img/COCO.png'%}" alt="" class="coco" />
          </a>
        </div>

        <ul class="layout">
          <li>
            <img src="{% static 'img/home.png'%}" alt="" class="size" />
            <a href="{% url 'myPage:myPage' request.user.id%}" class="mypage"
              >Mypage</a
            >
          </li>
          {% if user.town %}
          <li>
            <img
              src="{% static 'img/building_.jpg'%}"
              style="
                width: 22px;
                height: 22px;
                padding-top: 3px;
                margin-right: 5px;
              "
              alt=""
            />
            <a href="{% url 'town:myTown'%}" class="mytown">Mytown</a>
          </li>
          <li>
            <img src="{% static 'img/article.png'%}" alt="" class="size" />
            <a href="{% url 'blog:home' %}" class="thread">게시판</a>
          </li>
          {% endif %}
          <li>
            <img
              src="{% static 'img/perm_identity.png'%}"
              alt=""
              class="size"
            />
            <a href="{% url 'user:signout'%}" class="login">Sign Out</a>
          </li>
          <li>
            <img
              src="{% static 'img/Setting.png'%}"
              style="width: 23px; height: 23px; margin-right: 5px"
              alt=""
            />
            <a href="{% url 'town:setting'%}" class="setting">설정</a>
          </li>
        </ul>
      </div>
    </header>
    <div class="mainContainer">
      <div class="subContainer">
        {% if myPage.mainImage%}
        <img
          src="{{myPage.mainImage.url}}"
          class="backgroundImage"
          id="mainImage"
        />
        {% else %}
        <img
          src="{% static 'img/image.png'%}"
          class="backgroundImage"
          id="mainImage"
        />
        {% endif %}
    
        <img
          src="{% static 'img/addBtn.png'%}"
          class="addBgButton mainBg"
          onclick="chooseFile('mainImage')"
        />
        <div class="profileContainer">
          <div class="profileHeader">
            {% if user == owner%}
            <a href="{%url 'user:new_profile'%}">
              <img src="{% static 'img/settings.png' %}" class="settingBtn" />
            </a>
            {% endif %}
          </div>
          {% if profile.image %}
          <img src="{{ profile.image.url }}" class="profileImage" />
          {% else %}
          <img src="{% static 'img/profile.png' %}" class="profileImage" style="border: 2px solid #fff;"/>
          {% endif %}
          <h1 class="userName">{{profile.nickname}}</h1>
          <div class="introBox">{{profile.introduce}}</div>
        </div>
        {% if user == owner%}
        <img
          src="{% static 'img/Plus.png' %}"
          class="addImageBtn"
          onclick="editBackground('{{user.id}}')"
        />
        {% endif %}
        <div class="subBackgroundImage">
          {% if myPage.subImage1%}
          <img src="{{myPage.subImage1.url}}" class="subImage" id="subImage1" />
          {% else %}
          <img src="{% static 'img/image.png'%}" class="subImage" id="subImage1" />
          {% endif %} {% if myPage.subImage2%}
          <img src="{{myPage.subImage2.url}}" class="subImage" id="subImage2" />
          {% else %}
          <img src="{% static 'img/image.png'%}" class="subImage" id="subImage2" />
          {% endif %} {% if myPage.subImage3%}
          <img src="{{myPage.subImage3.url}}" class="subImage" id="subImage3" />
          {% else %}
          <img src="{% static 'img/image.png'%}" class="subImage" id="subImage3" />
          {% endif %}
          <img
            src="{% static 'img/addBtn.png'%}"
            class="addBgButton subBg1"
            onclick="chooseFile('subImage1')"
          />
          <img
            src="{% static 'img/addBtn.png'%}"
            class="addBgButton subBg2"
            onclick="chooseFile('subImage2')"
          />
          <img
            src="{% static 'img/addBtn.png'%}"
            class="addBgButton subBg3"
            onclick="chooseFile('subImage3')"
          />
        </div>

        <hr style="width: 100%; margin: 0 0 20px 0" id ="articlePart"/>
        <h2 style="margin-bottom: 20px;" id ="articlePart">게시글</h2>

        <div class="articleContainer" id ="articlePart">
          {% for article in articles reversed %}
          <div class="articleBox">
            <div class="titleBox">
              {{article.title}}
              <button
                class="articleDetailBtn"
                onclick="goToDetail('{{article.id}}')"
              >
                자세히 보기
              </button>
            </div>
            <div class="articleFooter">
              <p>{{article.created_at}}</p>
              <p>{{article.mypage.user.profile.nickname}}</p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% if user == owner%}
    <div class="articleAddBtnBox" id ="articlePart">
      <button class="articleAddBtn" onclick="goToNewArticle()">
        게시글 작성
      </button>
    </div>
    {% endif %}
  </body>
</html>
